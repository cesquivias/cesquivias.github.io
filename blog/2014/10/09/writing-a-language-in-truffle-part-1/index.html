<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Writing a Language in Truffle: Part 1</title>
    <meta name="description" content="Ever since implementing a meta circular evaluator in college I've enjoyed implementing little lisp interpreters in languages. It's one of those starting projects I do when learning a new programming language. When I first learned Python and implemented a ...">
    <meta name="author"      content="Cristian Esquivias">
    <meta name="keywords"    content="java, truffle">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/favicon.ico">
    <link rel="canonical" href="http://cesquivias.github.io/blog/2014/10/09/writing-a-language-in-truffle-part-1/">


    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <link rel="stylesheet" type="text/css" href="/css/scribble.css">
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <!-- Feeds -->
    <link ref="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link ref="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-xxxxx']);
      _gaq.push(['_setDomainName', 'example.com']);
      _gaq.push(['_trackPageview']);
      setTimeout(function(){_gaq.push(['_trackEvent', '30_seconds', 'read'])}, 30000); // http://drawingablank.me/blog/fix-your-bounce-rate.html
      (function() {
          var ga = document.createElement('script');
          ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <!-- A standard Twitter Bootstrap nav bar -->
    <header class="navbar navbar-default"
            role="banner">
      <div class="container">
        <div class="navbar-header">
          <button type="button"
                  class="navbar-toggle"
                  data-toggle="collapse"
                  data-target=".our-nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="/index.html" class="navbar-brand">Cristian Esquivias</a>
        </div>
        <div class="collapse navbar-collapse our-nav-collapse"
             role="navigation">
          <ul class="nav navbar-nav">

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="/index.html">All Posts</a></li>

<li><a href="/tags/java.html">java</a></li>

<li><a href="/tags/truffle.html">truffle</a></li>
              </ul>
            </li>
            <li>
              <a href="/About.html">About</a>
            </li> 
            <li><a href="/feeds/all.atom.xml">Atom</a></li>
            <li><a href="/feeds/all.rss.xml">RSS</a></li>
          </ul>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="row">

        <!-- Main column -->
        <div id="content" class="col-md-12">



          <article>
  <header>
    <h1>Writing a Language in Truffle: Part 1</h1>
    <p class='date-and-tags'>
<time datetime="2014-10-09" pubdate="true">2014-10-09</time> :: <span class="tags"><a href="/tags/java.html">java</a>, <a href="/tags/truffle.html">truffle</a></span></p>
  </header>

<p>Ever since implementing a <a href="https://mitpress.mit.edu/sicp/full-text/sicp/book/node76.html">meta circular evaluator</a> in college I&rsquo;ve enjoyed implementing little lisp interpreters in languages. It&rsquo;s one of those starting projects I do when learning a new programming language. When I first learned Python and implemented a lisp interpreter I was amazed at how small and easy to read the implementation was. Little did I know Peter Norvig beat me to <a href="http://norvig.com/lispy.html">a better python lisp interpreter</a>. Nonetheless, it&rsquo;s a fun little exercise to get acquainted with a new programming environment and appeases my curiosity in languages and interpreters.</p>

<p>Of course my toy interpreters are just that: a toy. Writing a lisp interpreter on top of an already slow language like Python will not win any speed competitions. You may get away with writing small Domain Specific Languages (DSLs) as an interpreter, but you can forget about any general programming language. The performance hit makes it untenable unless you write it in some lower level language like C; who wants to do that? If you want to target higher level virtual machines like the JVM you&rsquo;re left with writing a compiler that takes your code and produces JVM bytecode. How about writing a compiler that targets Javascript? Another not-so-fun alternative.</p>

<p>Thankfully, a new solution is here. You can write your interpreter in a VM that is designed to optimize your interpreter with all that wonderful JIT compilation magic. <a href="http://pypy.org/">PyPy</a> has been around for a few years and has grown into such an environment. It originally started as a new Python interpreter written in a smaller, more restricted version of Python appropriately named RPython (R = restricted). You don&rsquo;t get all the syntactic goodness of regular Python but, it sure beats writing your interpreter in C. The developers have made herculean efforts to create a VM that can take a high level language like Python and make it fast even when written in a still high level language like RPython. It&rsquo;s so good it&rsquo;s <a href="http://speed.pypy.org/">faster than the standard CPython</a> implementation in most benchmarks. It&rsquo;s such a promising platform there&rsquo;s an implementation of Ruby called <a href="http://topazruby.com/">Topaz</a> that is already performing <a href="http://mail.openjdk.java.net/pipermail/mlvm-dev/2013-February/005214.html">faster in some benchmarks</a> than the much more established implementations like JRuby. Exciting stuff, but now PyPy isn&rsquo;t the only game in town.</p>

<p>Oracle labs has <a href="http://www.oracle.com/technetwork/oracle-labs/program-languages/overview/index-2301583.html">released its own VM</a> that hopes to achieve the same results as PyPy but that leverages the huge ecosystem of the Java Virtual Machine (JVM). This modified JVM contains a new Just-In-Time (JIT) compiler that can speed up interpreters like my little lisp to near-Java speeds. The new JIT compiler is called Graal. To take advantage of Graal&rsquo;s JIT-y goodness you use the Truffle library to annotate your interpreter and give Graal some hints on invariants and type information. For this integration effort you get significant speedups in your interpreter without having to resort to writing a bytecode compiler plus you have the full power of Java at your disposal.</p>
<!-- more-->

<p>The initial results of Truffle are very exciting. Implementations of Ruby and Javascript in Truffle have performances on the same order of magnitude as the much bigger projects of JRuby and Nashorn, respectively. They are even comparable in speed to more established projects like the Google&rsquo;s V8 Javascript interpreter. The kick: these Truffle implementations were done with fewer people in a shorter period of time. This means you can create your own language on the JVM that takes advantage of all it&rsquo;s existing libraries, native threading, JIT compiler without without having to write your own fullblown optimizing compiler, <em>and</em> you get speeds that took other languages man-years (man-decades?) to achieve. Where do I sign up?</p>

<p>To see if the claims are true I&rsquo;m going to write another simple Lisp language which I&rsquo;ll unimaginatively call Truffler and see how easy it is. I&rsquo;ll write a simple, non-Truffle interpreter and judge how easy it is to translate to Truffle. I&rsquo;ll take benchmarks to see what kind of speed gains we get by switching over to Truffle. If everything goes well, perhaps this proof of concept will reach speeds comparable to other production-quality lisps like Clojure, Racket or CHICKEN (scheme), but I&rsquo;m getting ahead of myself.</p>

<h1 id="truffler-language">Truffler Language</h1>

<p>I&rsquo;m going to try to keep a balance between simplicity and useful features. I don&rsquo;t want a language that&rsquo;s so simple that it&rsquo;s a strawman, but I don&rsquo;t want to spend too much time writing a language I intend to throw away. Truffler will be a simple but fullblown language. I&rsquo;ll stick to basic datatypes and little-to-no syntactic sugar.</p>

<p>For those unfamiliar with lisps, it operates much like other dynamic languages. The biggest difference to most people is all the parentheses in the syntax, but they are there for a reason. Lisp programs are written in its own datatypes. This means that every element you see in Truffler (and all lisps) is the same datatype you use within your own program. This uniformity gives lisps a lot of power which Truffler sadly doesn&rsquo;t tap for the sake of brevity. The language will have a syntax as simple as possible and only a couple of datatypes. Lisps can go very far with what would normally be considered an anemic set of types and operations.</p>

<h2 id="datatypes">Datatypes</h2>

<ul>
 <li>
  <p>Numbers (e.g., <code>1</code>, <code>400</code>)</p>
  <p>Truffler will stick with positive integer literals. You can use the <code>-</code> function to create negative numbers if need be. This will be implemented by boxed Long. It&rsquo;s slow, but we&rsquo;re shooting for a barebones language. We also won&rsquo;t deal with integer overflows.</p></li>
 <li>
  <p>Boolean (i.e., <code>#t</code>, <code>#f</code>)</p>
  <p>Nothing special here. The tokens <code>#t</code> and <code>#f</code> will evaluate to the Java static final values <code>Boolean.TRUE</code> and <code>Boolean.FALSE</code>, respectively.</p></li>
 <li>
  <p>Symbol (e.g., <code>var</code>, <code>some-variable</code>)</p>
  <p>Symbols are kind of unique to lisps. If you&rsquo;re not familiar with them, they&rsquo;re string-like but are typically used for keys. Think of symbols in Ruby if you&rsquo;re familiar with Ruby but without the <code>:</code> in the front. Symbols show their uniqueness when they&rsquo;re evaluated.</p></li>
 <li>
  <p>Function (e.g., <code>(lambda (x) (+ x 1))</code>)</p>
  <p>Functions are written with the <code>lambda</code> special form. Functions are first class values that can be stored in a variable, passed to another function or returned by a function.</p></li>
 <li>
  <p>List (e.g., <code>(1 2 3)</code>, <code>(a list of symbols)</code>)</p>
  <p>Lists are the only way to make compound structures in Truffler. It&rsquo;s a little limiting but it&rsquo;s plenty for our little language.</p>
  <p>Lists are implemented as singly-linked lists. There are pros and cons with this implementation, but it&rsquo;s the traditional implementation in lisps. We&rsquo;re not blazing any trails here with language design so we&rsquo;ll stick with the tried and true implementation.</p>
  <p>The empty list <code>()</code> acts as Trufflers <code>null</code> value.</p></li></ul>

<h2 id="syntax">Syntax</h2>

<p>The syntax is simple.</p>

<ul>
 <li>Tokens are separated by whitespace or opening/closing parentheses.</li>
 <li>Numbers are tokens that are digits. Only numbers can begin with a digit.</li>
 <li>Booleans are the tokens <code>#t</code> <code>#f</code>. Any other token that begins with <code>#</code> is illegal.</li>
 <li>An open paren <code>(</code> starts a new list. A <code>)</code> is closes the list. Lists can be nested.</li>
 <li>Everything else is a symbol.</li></ul>

<p>Here is some syntactically correct Truffler code:</p>

<pre><code>    12344
    -123
    the-above-is-a-symbol-because-Truffler-does-not-have-negative-numbers
    #t
    (a list of symbols)</code></pre>

<h2 id="evaluation">Evaluation</h2>

<p>To keep with our theme of simple, evaluation is as basic as we can make it. The program is evaluated from top to bottom. That means that a variable definition must appear before its use. Everything is an expression. Since Truffler programs are made of Truffler datatypes every datatype has a well-defined evaluation strategy.</p>

<ul>
 <li>
  <p>Number (e.g., <code>1</code>, <code>4929</code>)</p>
  <p>Numbers evaluate to themselves. That is, a number returns a number. Shocking, I know.</p></li>
 <li>
  <p>Boolean (e.g., <code>#f</code>)</p>
  <p>Booleans evaluate to themselves. Same as above.</p></li>
 <li>
  <p>Symbol (e.g, <code>a-variable</code>, <code>a-variable-that-contains-a-function</code>)</p>
  <p>Symbols evaluate by returning looking the current namespace and return the value with the same name as the symbol. When you say <code>some-variable</code> the interpreter will see a symbol and try to evaluate it by looking in the current namespace for something stored under <code>"some-variable"</code>.</p></li>
 <li>
  <p>List (e.g., <code>(+ 1 2 3)</code>)</p>
  <p>Lists are evaluated as function calls. Every element in the list is evaluated before the function is applied to its arguments. The first element must evaluate to a function. The rest of the elements are the arguments. The arguments are mapped to the formal parameter names before the body of the function is called. The last expression in the function body is the return value.</p></li></ul>

<h2 id="scoping">Scoping</h2>

<p>Truffler has lexical scope. If you&rsquo;ve used any modern dynamic languages like Javascript, Python or Ruby then you know how this works. Basically, it means that functions defined within a wrapping function has access to the outer function&rsquo;s variables&mdash;even if the inner function is the return value and is not called until some time in the future.</p>

<p>Truffler doesn&rsquo;t have blocks (the list of statements within <code>{}</code> in languages like Java, C, C++). New scopes are only created within new functions.</p>

<h2 id="special-forms">Special Forms</h2>

<p>The evaluation process for function calls is defined to evaluate all the arguments, but we don&rsquo;t want this in certain circumstances. In these cases we&rsquo;ve defined unique evaluation schemes called special forms.</p>

<ul>
 <li>
  <p><code>define</code></p>
  <p>This creates a new variable within the current scope. <code>define</code> has to be a special form because the variable name doesn&rsquo;t exist yet (which is why we&rsquo;re calling <code>define</code>) and would throw an error for an undefined variable.</p>
  <p>Example: <code>(define c 299792458)</code></p></li>
 <li>
  <p><code>lambda</code></p>
  <p>This creates an anonymous function. The second element (the first being the symbol <code>lambda</code>) is the list of formal parameters. Lambda will be used with <code>define</code> to store a function with a name. <code>lambda</code> has to be a special form because we don&rsquo;t want to evaluate the body immediately; only when the function is the first element in a function call. Also, the arguments need to be mapped to the parameter names before the body can be evaluated or else we would get undefined variable errors.</p>
  <p>The name <code>lambda</code> is used for historical purposes. We&rsquo;ll just say that it&rsquo;s the traditional name for anonymous functions in lisps and leave it at that.</p>
  <p>Example: <code>(lambda (x) (* x x))</code></p></li>
 <li>
  <p><code>if</code></p>
  <p>The only control flow structure in Truffle. This works as you&rsquo;d expect, the second element (the test expression) is evaluated, and if it&rsquo;s true the 3rd element (the &ldquo;then&rdquo; expression) is evaluated. If it&rsquo;s false the 4th element is evaluated. <code>if</code> has to be a special form because only the then or the else expression must be evaluated. If <code>if</code> was a normal function both clauses would be evaluated, the else expression would always return, and that would be bad.</p>
  <p>Remember, <code>if</code> is an expression like everything else. It returns the result of evaluation of either the then or else expression. Lisp ifs are more like the C-style ternary operator: <code>test() ? then_result() : else_result()</code>.</p>
  <p>Example: <code>(if (= x 0) (+ x 1) (- x 3))</code></p></li>
 <li>
  <p><code>quote</code></p>
  <p>This returns the argument without evaluating it. Since all instances of Symbol and List types in Truffler evaluate to variable lookup and function calls, respectively, we need a way to get a hold of actual Symbol and List objects. <code>quote</code> allows us to do that. With lists you can use the <code>list</code> builtin function to get a list object, but symbols need <code>quote</code> because there&rsquo;s no other way to get a Symbol object.</p>
  <p>Keep in mind, quote doesn&rsquo;t evaluate anything in its argument. That means if you pass a list it&rsquo;s elements are not evaluated. A symbol within a list will stay a symbol. You&rsquo;re better off using the <code>list</code> function unless you really want a list of symbols.</p>
  <p>Because numbers and booleans evaluate to themselves, quoting them doesn&rsquo;t do anything.</p>
  <p>Example: <code>(quote (a list of undefined symbols))</code></p></li></ul>

<p>With these few special forms we have a fully functional, Turing-complete programming language. We&rsquo;ll have to be creative in combining them to get the functionality we need, but that&rsquo;s part of the power of lisp.</p>

<h2 id="builtin-functions">Builtin Functions</h2>

<p>Although we have a Turing-complete language it isn&rsquo;t very useful if we can&rsquo;t do anything like interact with the outside world or manipulate our datatypes. Here are the builtin functions that come with Truffler. There&rsquo;s nothing special about these functions other than they already exist when Truffler starts. They are evaluated and called like user-defined functions.</p>

<ul>
 <li>
  <p>Arimetic functions (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%</code>, <code>=</code>, <code>&gt;</code>, <code>&lt;</code>)</p>
  <p>We have your basic arithmetic operations. Remember, Truffler only has integers so <code>/</code> does integer division and <code>%</code> is the modulo function.</p></li>
 <li>
  <p>List functions (<code>list</code>, <code>cons</code>, <code>car</code>, <code>cdr</code>)</p>
  <p>Our basic functions for creating, prepending and splicing lists. The names <code>cons</code>, <code>car</code>, <code>cdr</code> probably don&rsquo;t make sense if you&rsquo;re unfamiliar with lisp but they basically mean <code>prepend</code>, <code>first</code>, <code>rest</code> respectively. Again, we&rsquo;re sticking with lisp tradition here. For more background, you can read the Wikpedia article on <a href="http://en.wikipedia.org/wiki/Cons">cons</a>.</p></li>
 <li>
  <p>IO functions (<code>println</code>, <code>now</code>)</p>
  <p>Since we&rsquo;re not planning to do any real work in Truffler, we&rsquo;ll just implement a function to send data to standard out and get a current timestamp.</p></li></ul>

<p>I may have to add more functions in the future but this is a good start.</p>

<h1 id="simpletruffler">SimpleTruffler</h1>

<p>Now with a clear idea of what language we&rsquo;re creating, let&rsquo;s get started! We&rsquo;ll start with an interpreter that <em>doesn&rsquo;t</em> use Truffle as a base comparison. This version will be written the way I would normally write toy langauges, à la Peter Norvig&rsquo;s <a href="http://norvig.com/lispy.html">lispy</a>.</p>

<h2 id="design">Design</h2>

<p>The architecture will be a simple pipline from program text to evaluated result.</p>

<pre><code>    Read program text and return tree of expressions -&gt; evaluate tree</code></pre>

<p>The <code>Reader</code> class will encapsulate converting from program text and return the tree of Truffler expressions. The abstract syntax tree&rsquo;s (AST&rsquo;s) top node will be called with a default environment that includes all builtin functions. When interpreting a file the result of the top evaluation will be dropped.</p>

<p>Our main class will look like:</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleTrufflerMain</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">:</span> <span class="s">"Truffler file required"</span><span class="o">;</span>
        <span class="n">runTruffler</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runTruffler</span><span class="o">(</span><span class="n">String</span> <span class="n">filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">Environment</span> <span class="n">topEnv</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="na">getBaseEnvironment</span><span class="o">();</span>

        <span class="n">TrufflerListNode</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">));</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Node</span> <span class="n">node</span> <span class="o">:</span> <span class="n">nodes</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">node</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">topEnv</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="repl">REPL</h2>

<p>We can make a small addition at essentially no cost. We can take the basic flow described above and wrap it in a <code>while</code> loop and create a <a href="http://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">REPL</a>. If you&rsquo;ve ever used languages like Python, Ruby or the Javascript console in web browsers you know a REPL. The REPL takes the text passed to it by the user and follows the flow above but then prints out the result instead of dropping it. We wrap it all in a <code>while</code> loop so we always return back to the prompt.</p>

<p>Our updated main class is:</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleTrufflerMain</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">:</span> <span class="s">"SimpleTruffler only accepts 1 or 0 files"</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">startREPL</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">runTruffler</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">startREPL</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">Environment</span> <span class="n">topEnv</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="na">getBaseEnvironment</span><span class="o">();</span>

        <span class="n">Console</span> <span class="n">console</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">console</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// READ</span>
            <span class="n">String</span> <span class="n">data</span> <span class="o">=</span> <span class="n">console</span><span class="o">.</span><span class="na">readLine</span><span class="o">(</span><span class="s">"~&gt; "</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// EOF sent</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">TrufflerListNode</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">ByteArrayInputStream</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>

            <span class="c1">// EVAL</span>
            <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ListNode</span><span class="o">.</span><span class="na">EMPTY</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Node</span> <span class="n">node</span> <span class="o">:</span> <span class="n">nodes</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">topEnv</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// PRINT</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">TrufflerListNode</span><span class="o">.</span><span class="na">EMPTY</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runTruffler</span><span class="o">(</span><span class="n">String</span> <span class="n">filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">Environment</span> <span class="n">topEnv</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="na">getBaseEnvironment</span><span class="o">();</span>

        <span class="n">TrufflerListNode</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">));</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Node</span> <span class="n">node</span> <span class="o">:</span> <span class="n">nodes</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">node</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">topEnv</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>We&rsquo;re being a little quick and dirty with IOExceptions but the happy path will work fine. Now time to delve into the converting an <code>InputStream</code> into a tree of Truffler expressions.</p>

<h2 id="reading">Reading</h2>

<p>Typically, languages break this up into two stages: lexing (text -&gt; tokens), parsing (tokens -&gt; syntax tree). I&rsquo;m going to take another page from lisp history and combine lexing and paring into one step: reading. Because we were careful in defining the syntax of Truffler, we can easily hand-write a reader that only needs one character of look ahead to determine what token is being read.</p>

<p>The basic flow of the reader is to read one character then dispatch to specialized read methods depending on the character read. Our <code>readNode</code> function:</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">Node</span> <span class="nf">readNode</span><span class="o">(</span><span class="n">PushbackReader</span> <span class="n">pstream</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span> <span class="n">pstream</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
    <span class="n">pstream</span><span class="o">.</span><span class="na">unread</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;(&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">readList</span><span class="o">(</span><span class="n">pstream</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">Character</span><span class="o">.</span><span class="na">isDigit</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">readNumber</span><span class="o">(</span><span class="n">pstream</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">readBoolean</span><span class="o">(</span><span class="n">pstream</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;)&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Unmatched close paren"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">readSymbol</span><span class="o">(</span><span class="n">pstream</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>If you look closely at our implementation of SimpleTrufflerMain you&rsquo;ll see that we call <code>Reader.read</code> and it returns a TrufflerListNode. Our <code>read</code> method can read multiple nodes at once and return them all. The <code>read</code> method:</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">TrufflerListNode</span> <span class="nf">read</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">istream</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">read</span><span class="o">(</span><span class="k">new</span> <span class="n">PushbackReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">istream</span><span class="o">)));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="n">TrufflerListNode</span> <span class="nf">read</span><span class="o">(</span><span class="n">PushbackReader</span> <span class="n">pstream</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">nodes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;();</span>

    <span class="n">readWhitespace</span><span class="o">(</span><span class="n">pstream</span><span class="o">);</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span> <span class="n">pstream</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="n">c</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">pstream</span><span class="o">.</span><span class="na">unread</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="n">nodes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">readNode</span><span class="o">(</span><span class="n">pstream</span><span class="o">));</span>
        <span class="n">readWhitespace</span><span class="o">(</span><span class="n">pstream</span><span class="o">);</span>
        <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span> <span class="n">pstream</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">TrufflerListNode</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">nodes</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Within <code>Reader</code> we only deal with <code>PushbackReader</code> objects. The public method <code>read(InputStream istream)</code> just converts the <code>InputStream</code> to a <code>PushbackReader</code>.</p>

<p>As you can see the <code>read</code> method is straightforward. It accumulates all Node values into a list while the end-of-file hasn&rsquo;t been reached then returns a TrufflerListNode when it&rsquo;s done. It&rsquo;s also responsible for reading and throwing away whitespace so <code>readNode</code> doesn&rsquo;t have to worry about it.</p>

<p>I&rsquo;m going to skip passed showing all the different read methods. They&rsquo;re what you expect: read until you find a separator then convert the string to it&rsquo;s respective type (i.e., number, boolean or symbol). I will show how lists are read because of some interesting twists. Lists are recursive and can read other nodes. We also check for special forms.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">private</span> <span class="kd">static</span> <span class="n">Node</span> <span class="nf">readList</span><span class="o">(</span><span class="n">PushbackReader</span> <span class="n">pstream</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="kt">char</span> <span class="n">paren</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span> <span class="n">pstream</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
    <span class="k">assert</span> <span class="n">paren</span> <span class="o">==</span> <span class="sc">&#39;(&#39;</span> <span class="o">:</span> <span class="s">"Reading a list must start with &#39;(&#39;"</span><span class="o">;</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;();</span>
    <span class="k">do</span> <span class="o">{</span>
        <span class="n">readWhitespace</span><span class="o">(</span><span class="n">pstream</span><span class="o">);</span>
        <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span> <span class="n">pstream</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;)&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// end of list</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="n">c</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">EOFException</span><span class="o">(</span><span class="s">"EOF reached before closing of list"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">pstream</span><span class="o">.</span><span class="na">unread</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">readNode</span><span class="o">(</span><span class="n">pstream</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">SpecialForm</span><span class="o">.</span><span class="na">check</span><span class="o">(</span><span class="n">TrufflerListNode</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">list</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The two interesting bits of this method are (1) we recursively call <code>readNode</code> to handle reading all elements in the list. Because start and end parentheses are separators we know that <code>readList</code> will get back control once they are reached; (2) We call <code>SpecialForm.check</code> to see if the list is not a function but actually one of our four special forms. The code for <code>SpecialForm.check</code> is straightforward.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">SymbolNode</span> <span class="n">DEFINE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SymbolNode</span><span class="o">(</span><span class="s">"define"</span><span class="o">);</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">SymbolNode</span> <span class="n">LAMBDA</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SymbolNode</span><span class="o">(</span><span class="s">"lambda"</span><span class="o">);</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">SymbolNode</span> <span class="n">IF</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SymbolNode</span><span class="o">(</span><span class="s">"if"</span><span class="o">);</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">SymbolNode</span> <span class="n">QUOTE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SymbolNode</span><span class="o">(</span><span class="s">"quote"</span><span class="o">);</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">Node</span> <span class="nf">check</span><span class="o">(</span><span class="n">TrufflerListNode</span> <span class="n">l</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="n">TrufflerListNode</span><span class="o">.</span><span class="na">EMPTY</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">car</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">DEFINE</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DefineSpecialForm</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">car</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">LAMBDA</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">LambdaSpecialForm</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">car</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">IF</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">IfSpecialForm</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">l</span><span class="o">.</span><span class="na">car</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">QUOTE</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">QuoteSpecialForm</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>There&rsquo;s nothing special about checking for special forms. I just want to make sure they aren&rsquo;t evaluated as function calls. We&rsquo;ll go into more detail about special forms later. The reader checks for special forms so the list type doesn&rsquo;t have to constantly check if the first element of the is a special form when evaluating. This will speed up evaluation of function calls.</p>

<h2 id="eval">Eval</h2>

<p>All the nodes the reader returns extend from the abstract class <code>Node</code>. All <code>Node</code> does is define an abstract method <code>eval</code>. <code>eval</code> takes an <code>Environment</code> argumnet that contains the namespace for all the defined variables. For most datatypes (Number, Boolean, Function) <code>eval</code> returns the same object. Actually, Number and Boolean return the boxed values of <code>java.lang.Long</code> and <code>java.lang.Boolean</code>, respectively, because Java doesn&rsquo;t allow us to subclass <code>java.lang.Long</code> and <code>java.lang.Boolean</code>. If we could we would just return <code>this</code> in those cases. The difference is subtle and doesn&rsquo;t really matter. For the <code>Function</code> type, we do return <code>this</code> since we define a custom type.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Node</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="n">Environment</span> <span class="n">env</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Number</span> <span class="kd">extends</span> <span class="n">Node</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Long</span> <span class="n">num</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">Number</span><span class="o">(</span><span class="n">Long</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">num</span> <span class="o">=</span> <span class="n">num</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="n">Environment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">num</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Function</span> <span class="kd">extends</span> <span class="n">Node</span> <span class="o">{</span>
    <span class="c1">// other code...</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="n">Environment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p><code>Symbol</code> is a little more complicated but only just. When <code>Symbol</code> is evaluated the name of the value is looked up in the <code>Environment</code> namepace and the value stored there is returned.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SymbolNode</span> <span class="kd">extends</span> <span class="n">Node</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">SymbolNode</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="n">Environment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The Environment class is just a simple mapping between strings and objects. Because Truffler is lexically scoped, the Environment&rsquo;s parent is searched if the name cannot be found. If the top parent is reached and the name is never found an exception is thrown.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Environment</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Environment</span> <span class="n">parent</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">Environment</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">Environment</span><span class="o">(</span><span class="n">Environment</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">env</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">env</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">parent</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"No variable: "</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putValue</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p><code>TrufflerListNode</code> is evaluated as a function call. This means all elements of the list are first evaluated by calling their respective <code>eval</code> methods. The first element is then cast to a <code>Function</code> and its <code>apply</code> method is called with the rest of the list elements passed as arguments.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TrufflerListNode</span> <span class="kd">extends</span> <span class="n">Node</span> <span class="kd">implements</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// other code...</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="n">Environment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Function</span> <span class="n">function</span> <span class="o">=</span> <span class="o">(</span><span class="n">Function</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">car</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Node</span> <span class="n">node</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">cdr</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">args</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">env</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">function</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">toArray</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h3 id="function-invocation">Function invocation</h3>

<p>This would be a good time to discuss what happens when user-defined functions (lambdas) are called. Remember that lambdas are really nothing more than a list of nodes so all we really need to do is evaluate the nodes in order then return the value of the final one. There are a couple of little twists. First, functions start a new namespace that have their outer function&rsquo;s namespace as their parent. Second, functions can have arguments so we&rsquo;ll need to put the arguments in the function&rsquo;s new namespace before we start evaluating the body lest we get incorrect unknown variable exceptions. Here&rsquo;s the <code>Function</code> instance that&rsquo;s returned when you use a lambda special form.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="k">new</span> <span class="nf">Function</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Environment</span> <span class="n">lambdaEnv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Environment</span><span class="o">(</span><span class="n">parentEnv</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="n">formalParams</span><span class="o">.</span><span class="na">length</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                    <span class="s">"Wrong number of arguments. Expected: "</span> <span class="o">+</span>
                            <span class="n">formalParams</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">+</span> <span class="s">". Got: "</span> <span class="o">+</span>
                            <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// Map parameter values to formal parameter names</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Node</span> <span class="n">param</span> <span class="o">:</span> <span class="n">formalParams</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">SymbolNode</span> <span class="n">paramSymbol</span> <span class="o">=</span> <span class="o">(</span><span class="n">SymbolNode</span><span class="o">)</span> <span class="n">param</span><span class="o">;</span>
            <span class="n">lambdaEnv</span><span class="o">.</span><span class="na">putValue</span><span class="o">(</span><span class="n">paramSymbol</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="n">i</span><span class="o">++;</span>
        <span class="o">}</span>

        <span class="c1">// Evaluate body</span>
        <span class="n">Object</span> <span class="n">output</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Node</span> <span class="n">node</span> <span class="o">:</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">lambdaEnv</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h3 id="special-form-evaluation">Special form evaluation</h3>

<p>We&rsquo;ve covered how Truffler&rsquo;s basic datatypes are evaluated; all that&rsquo;s left are the few special cases: <code>define</code>, <code>lambda</code>, <code>if</code> and <code>quote</code>. Remember, in the <code>Reader</code> when we encounter list forms that have these special symbols as their first element we replace the whole TrufflerListNode object with a new <code>SpecialForm</code>. This way, when we <code>eval</code> them, we can have whatever we want happen. For example, <code>define</code> takes the third element (a value) and stores it in the current namespace under the name given in the second element.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DefineSpecialForm</span> <span class="kd">extends</span> <span class="n">SpecialForm</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">DefineSpecialForm</span><span class="o">(</span><span class="n">TrufflerListNode</span> <span class="n">listNode</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">listNode</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="n">Environment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SymbolNode</span> <span class="n">sym</span> <span class="o">=</span> <span class="o">(</span><span class="n">SymbolNode</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">node</span><span class="o">.</span><span class="na">cdr</span><span class="o">.</span><span class="na">car</span><span class="o">;</span> <span class="c1">// 2nd element</span>
        <span class="n">env</span><span class="o">.</span><span class="na">putValue</span><span class="o">(</span><span class="n">sym</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
                <span class="k">this</span><span class="o">.</span><span class="na">node</span><span class="o">.</span><span class="na">cdr</span><span class="o">.</span><span class="na">cdr</span><span class="o">.</span><span class="na">car</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">env</span><span class="o">));</span> <span class="c1">// 3rd element</span>
        <span class="k">return</span> <span class="n">TrufflerListNode</span><span class="o">.</span><span class="na">EMPTY</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>I showed the return <code>Function</code> object for the <code>LambdaSpecialForm</code>. The rest of <code>LambdaSpecialForm</code> doesn&rsquo;t really do much beside getting references to the outer function&rsquo;s namespace and the formal parameters. Let&rsquo;s show the rest.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LambdaSpecialForm</span> <span class="kd">extends</span> <span class="n">SpecialForm</span> <span class="o">{</span>
     <span class="kd">public</span> <span class="nf">LambdaSpecialForm</span><span class="o">(</span><span class="n">TrufflerListNode</span> <span class="n">paramsAndBody</span><span class="o">)</span> <span class="o">{</span>
         <span class="kd">super</span><span class="o">(</span><span class="n">paramsAndBody</span><span class="o">);</span>
     <span class="o">}</span>

     <span class="nd">@Override</span>
     <span class="kd">public</span> <span class="n">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="kd">final</span> <span class="n">Environment</span> <span class="n">parentEnv</span><span class="o">)</span> <span class="o">{</span>
         <span class="kd">final</span> <span class="n">TrufflerListNode</span> <span class="n">formalParams</span> <span class="o">=</span> <span class="o">(</span><span class="n">TrufflerListNode</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">node</span><span class="o">.</span><span class="na">cdr</span><span class="o">.</span><span class="na">car</span><span class="o">;</span>
         <span class="kd">final</span> <span class="n">TrufflerListNode</span> <span class="n">body</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">node</span><span class="o">.</span><span class="na">cdr</span><span class="o">.</span><span class="na">cdr</span><span class="o">;</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nf">Function</span><span class="o">()</span> <span class="o">{</span> <span class="cm">/* function definition goes here */</span> <span class="o">};</span>
     <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The other <a href="https://github.com/cesquivias/truffler/blob/master/simple/src/truffler/simple/node/SpecialForm.java#L63"><code>if</code></a> and <a href="https://github.com/cesquivias/truffler/blob/master/simple/src/truffler/simple/node/SpecialForm.java#L83"><code>quote</code></a> special forms do what you expect. If you&rsquo;re interested, you can check out the code.</p>

<h3 id="builtin-functions">Builtin Functions</h3>

<p>We&rsquo;re in the homestretch of the implementation. The only thing left is creating our builtin functions. Since we&rsquo;re defining the function entirely in Java we can skip things like mapping arguments and just get straight into evaluating. Most of our numerical functions can take variable arguments. For example, addition can take 0 or more arguments. With 0 arguments <code>0</code> is returned, with 1 argument the argument is returned and with more the sum of all arguments is returned.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">static</span> <span class="kd">final</span> <span class="n">Function</span> <span class="n">PLUS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BuiltinFn</span><span class="o">(</span><span class="s">"PLUS"</span><span class="o">)</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sum</span> <span class="o">+=</span> <span class="o">(</span><span class="n">Long</span><span class="o">)</span> <span class="n">arg</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Subtraction requires at least one argument. With one argument it negates the argument, with more it continually subtracts from the first argument.</p>

<div class="brush: java">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">static</span> <span class="kd">final</span> <span class="n">Function</span> <span class="n">MINUS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BuiltinFn</span><span class="o">(</span><span class="s">"MINUS"</span><span class="o">)</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">" requires an argument"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
            <span class="k">return</span> <span class="o">-((</span><span class="n">Long</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="kt">long</span> <span class="n">diff</span> <span class="o">=</span> <span class="o">(</span><span class="n">Long</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">diff</span> <span class="o">-=</span> <span class="o">(</span><span class="n">Long</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">diff</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>You get the idea. You can see the implementation of the other builtin functions on <a href="https://github.com/cesquivias/truffler/blob/master/simple/src/truffler/simple/env/BuiltinFn.java">GitHub</a>.</p>

<h2 id="print">Print</h2>

<p>Rounding out the REPL, we print out the result. There&rsquo;s not much here. We just call <code>System.out.println</code> and that&rsquo;s that. Okay, there&rsquo;s one little catch. Since we use the empty list as Truffler&rsquo;s &ldquo;null&rdquo; value, we just don&rsquo;t print anything if that&rsquo;s what&rsquo;s returned in the REPL.</p>

<h1 id="truffler-in-action">Truffler in action</h1>

<p>Now that we have a language spec and an implementation we can take it for a spin. We would start with Hello World, but we didn&rsquo;t imlement strings! We&rsquo;ll do the next best thing and use symbols.</p>

<div class="brush: scheme">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="p">(</span><span class="nf">println</span> <span class="p">(</span><span class="k">quote </span><span class="nv">hello-world!</span><span class="p">))</span>
<span class="c1">; &#39;hello-world!</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Close enough, and it works! Let&rsquo;s try something a little more involved. How about the good ol&rsquo; fibonacci sequence.</p>

<div class="brush: scheme">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8
9</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="p">(</span><span class="k">define </span><span class="nv">fibonacci</span>
  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="nv">n</span> <span class="mi">2</span><span class="p">)</span>
        <span class="mi">1</span>
        <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">fibonacci</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">))</span>
           <span class="p">(</span><span class="nf">fibonacci</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">2</span><span class="p">))))))</span>

<span class="p">(</span><span class="nf">fib</span> <span class="mi">10</span><span class="p">)</span>
<span class="c1">; 55</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Great! We get the correct answer. We have a working program! As you can see, Truffler would be easier to read if it had nice sugar like a function-define, but we can get by without it.</p>

<h1 id="benchmarks">Benchmarks</h1>

<p>With our working program what kind of performance do we get? More importantly, how does it compare to other languages that have had a lot of effort put into them to make them fast? Let&rsquo;s take our fibonacci example and see how it performs in Racket and Node.js. The results:</p>

<pre><code>    rkt
    --------------
    1346269
    computation time: 15
    total time: 117

    js
    --------------
    1346269
    computation time: 16
    total time: 82</code></pre>

<p>That&rsquo;s pretty fast. How does SimpleTruffler do?</p>

<pre><code>    truffler
    --------------
    1346269
    ('computation-time: 1502)
    total time: 1644</code></pre>

<p>Ouch. Things aren&rsquo;t looking so hot for our little interpreter. It performs about 100x <em>slower</em> than Racket or Node.js. Now, both Racket and Node.js have JIT compilers and SimpleTruffler doesn&rsquo;t have any of that magic. What happens if we compare it to an interpreter with no JIT like CPython?</p>

<pre><code>    py
    --------------
    1346269
    computation time: 385
    total time: 400</code></pre>

<p>Better. SimpleTruffler is only 4x slower than CPython. Not bad for a language quicky thrown together. CPython is written in C and has a bytecode interpreter that helps explain why it&rsquo;s faster than our little language.</p>

<p>I&rsquo;ll settle for fibonacci as a benchmark. Our terribly inefficient algorithm gives us plenty of avenues for improvement. We make a lot of function calls so if we improve that we should get a big speed up. Getting rid of boxed longs would really help.</p>

<h2 id="algorithms--interpreter">Algorithms &gt; Interpreter</h2>

<p>Out of curiosity, I converted the Truffler implementation to one that uses a much faster, linear algorithm.</p>

<div class="brush: scheme">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="p">(</span><span class="k">define </span><span class="nv">fibonacci</span>
  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span>
    <span class="p">(</span><span class="k">define </span><span class="nv">iter</span>
      <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">i</span> <span class="nv">n1</span> <span class="nv">n2</span><span class="p">)</span>
        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">i</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nv">n2</span>
            <span class="p">(</span><span class="nf">iter</span> <span class="p">(</span><span class="nb">- </span><span class="nv">i</span> <span class="mi">1</span><span class="p">)</span>
                  <span class="nv">n2</span>
                  <span class="p">(</span><span class="nb">+ </span><span class="nv">n1</span> <span class="nv">n2</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nf">iter</span> <span class="nv">n</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>This version runs through the fibonacci numbers sequentially instead of blowing up exponentially. This is an example of <a href="http://mitpress.mit.edu/sicp/full-text/book/book-Z-H-11.html#%_sec_1.2.1">linear recursion</a> vs <a href="http://mitpress.mit.edu/sicp/full-text/book/book-Z-H-11.html#%_sec_1.2.2">tree recursion</a>. You can read <a href="http://mitpress.mit.edu/sicp/full-text/book/book-Z-H-11.html#%_sec_1.2">SICP</a> for more info on this. So how does our smarter algorithm perform:</p>

<pre><code>    truffler
    --------------
    1346269
    ('computation-time: 8)
    total time: 169</code></pre>

<p>Wow. Now that&rsquo;s an improvement. The algorithm chosen has much more to do with speed than the language implementation. In it&rsquo;s current state, SimpleTruffler could be &ldquo;good enough&rdquo; for many small tasks and give you reasonable speed. If you&rsquo;re writing a DSL to glue code written in other faster languages maybe a simple interpreter is all you need. But let&rsquo;s assume we&rsquo;re writing a general purpose language that needs faster function calls and numeric operations.</p>

<h1 id="next-time">Next Time</h1>

<p>We have a working language and we have some baseline numbers to see if Truffle improves on our dead-simple interpreter. Next time we&rsquo;ll actually start looking at Truffle and begin migrating SimpleTruffler over to it. Maybe along the way we&rsquo;ll add some more benchmarks to get a better picture of our language&rsquo;s speed.</p>
  <footer>
    <script type="text/javascript">
      !function(d,s,id){
          var js,fjs=d.getElementsByTagName(s)[0];
          if(!d.getElementById(id)){
              js=d.createElement(s);
              js.id=id;
              js.src="//platform.twitter.com/widgets.js";
              fjs.parentNode.insertBefore(js,fjs);
          }
      }(document,"script","twitter-wjs");
    </script>
    <a href="https://twitter.com/share"
       class="twitter-share-button"
       data-url="http://cesquivias.github.io/blog/2014/10/09/writing-a-language-in-truffle-part-1/"
       data-dnt="true">
      "Tweet"</a>
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
    <g:plusone size="medium" href="http://cesquivias.github.io/blog/2014/10/09/writing-a-language-in-truffle-part-1/"></g:plusone>
    <script type="text/javascript">
      var disqus_shortname = 'cesquivias';
      (function() {
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <div id="disqus_thread"></div>
    <ul class="pager">


    </ul>
  </footer>
</article>
        </div>
      </div>
      <footer>
        <hr />
        <p><a href="https://twitter.com/sergeantpepper"
              class="twitter-follow-button"
              data-show-count="false"
              data-lang="en">
             "Follow Cristian"
           </a>
           <script type="text/javascript">
             !function(d,s,id){
                 var js,fjs=d.getElementsByTagName(s)[0];
                 if(!d.getElementById(id)){
                     js=d.createElement(s);
                     js.id=id;
                     js.src="//platform.twitter.com/widgets.js";
                     fjs.parentNode.insertBefore(js,fjs);
                 }
             }(document,"script","twitter-wjs");
           </script></p>
        <p>Site generated
        by <a href="https://github.com/greghendershott/frog">Frog</a>,
        the <strong>fr</strong>ozen bl<strong>og</strong> tool.</p>
        <p>Using <a href="http://twitter.github.com/bootstrap/index.html">Bootstrap</a>.</p>
        <p>Copyright &copy; 2014 by Cristian Esquivias. All rights reserved.</p>
        <p>
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
        </p>
      </footer>
    </div>
    <!-- </body> JS -->
    <script type="text/javascript" src="//code.jquery.com/jquery.js"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  </body>
</html>